{% extends "advisor/base.html" %}
{% block title %}Diagnosis Report - {{ animal|capfirst }}{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Report Card -->
    <div class="report-card">
        <!-- Report Header -->
        <div class="report-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="report-title">
                        <i class="fas fa-file-medical"></i> {{ animal|capfirst }} Diagnosis Report
                    </h1>
                    <p class="report-subtitle">Animal Health Advisory System</p>
                </div>
                <div class="report-badge">
                    <span>Case #{{ case_id }}</span>
                    <small>{{ report_date }}</small>
                </div>
            </div>
        </div>

        <!-- Report Body -->
        <div class="report-body">
            <!-- Symptoms Section -->
            <section class="report-section">
                <div class="section-header">
                    <i class="fas fa-clipboard-check"></i>
                    <h2>Observed Symptoms</h2>
                </div>
                <div class="symptom-chips">
                    {% for symptom in symptoms %}
                    <div class="symptom-chip">{{ symptom }}</div>
                    {% endfor %}
                </div>
            </section>

            <!-- Diagnosis Section -->
            <section class="report-section diagnosis-section">
                <div class="section-header">
                    <i class="fas fa-diagnoses"></i>
                    <h2>Professional Diagnosis</h2>
                </div>
                <div class="diagnosis-card severity-{{ severity }}">
                    <div class="diagnosis-content">
                        <h3>{{ diagnosis }}</h3>
                        <div class="confidence-meter">
                            <div class="meter-labels">
                                <span>Confidence Level</span>
                                <span>{{ confidence }}%</span>
                            </div>
                            <div class="meter-bar">
                                <div class="meter-fill" style="width: {{ confidence }}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="severity-indicator">
                        <div class="severity-dot"></div>
                        <span>{{ severity|capfirst }} Severity</span>
                    </div>
                </div>
            </section>

            <!-- Treatment Plan -->
            <section class="report-section">
                <div class="section-header">
                    <i class="fas fa-prescription-bottle-alt"></i>
                    <h2>Treatment Protocol</h2>
                </div>
                <div class="treatment-plan">
                    <div class="treatment-steps">
                        {{ treatment|linebreaks }}
                    </div>
                    <div class="treatment-notes">
                        <h4><i class="fas fa-notes-medical"></i> Important Notes:</h4>
                        <ul>
                            <li>Complete the full course of treatment</li>
                            <li>Monitor for adverse reactions</li>
                            <li>Follow up in 3 days or if symptoms worsen</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Prevention Measures -->
            <section class="report-section">
                <div class="section-header">
                    <i class="fas fa-shield-virus"></i>
                    <h2>Prevention Strategy</h2>
                </div>
                <div class="prevention-grid">
                    {% for measure in prevention %}
                    <div class="prevention-card">
                        <div class="prevention-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <p>{{ measure }}</p>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>

        <!-- Report Footer -->
        <div class="report-footer">
            <div class="footer-actions">
                <button class="btn-print" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Report
                </button>
                <button class="btn-pdf" id="savePdf">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
            </div>
            <div class="footer-disclaimer">
                <p>This report is generated by the Animal Health Advisory System. For emergency cases, 
                please contact your veterinarian immediately.</p>
            </div>
        </div>
    </div>
</div>

<!-- PDF Export Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
document.getElementById('savePdf').addEventListener('click', function() {
    const element = document.querySelector('.report-card');
    const opt = {
        margin: 15,
        filename: '{{ animal|lower }}_diagnosis_report_{{ case_id }}.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
            scale: 2,
            logging: true,
            useCORS: true,
            letterRendering: true
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait',
            hotfixes: ["px_scaling"]
        }
    };
    
    // Show loading indicator
    const loader = document.createElement('div');
    loader.style.position = 'fixed';
    loader.style.top = '0';
    loader.style.left = '0';
    loader.style.width = '100%';
    loader.style.height = '100%';
    loader.style.backgroundColor = 'rgba(255,255,255,0.8)';
    loader.style.display = 'flex';
    loader.style.justifyContent = 'center';
    loader.style.alignItems = 'center';
    loader.style.zIndex = '9999';
    loader.innerHTML = '<div style="text-align:center"><i class="fas fa-spinner fa-spin fa-3x" style="color:#28a745"></i><p>Generating PDF...</p></div>';
    document.body.appendChild(loader);
    
    // Generate PDF
    html2pdf().set(opt).from(element).toPdf().get('pdf').then(function(pdf) {
        document.body.removeChild(loader);
    }).save();
});
</script>

<style>
    /* Base Styles */
    :root {
        --primary: #28a745;
        --primary-light: #5cb85c;
        --primary-dark: #218838;
        --secondary: #f8f9fa;
        --text: #212529;
        --light: #ffffff;
        --danger: #dc3545;
        --warning: #ffc107;
        --success: #28a745;
        --border-radius: 10px;
        --box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f5;
        color: var(--text);
        line-height: 1.6;
    }
    
    .container {
        max-width: 900px;
    }
    
    /* Report Card */
    .report-card {
        background: var(--light);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    /* Report Header */
    .report-header {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        padding: 2rem;
    }
    
    .report-title {
        font-weight: 700;
        margin: 0;
        font-size: 1.8rem;
    }
    
    .report-subtitle {
        opacity: 0.9;
        margin: 0.5rem 0 0;
        font-weight: 300;
    }
    
    .report-badge {
        background: rgba(255,255,255,0.2);
        padding: 0.75rem 1rem;
        border-radius: 50px;
        text-align: center;
    }
    
    .report-badge span {
        display: block;
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .report-badge small {
        font-size: 0.8rem;
        opacity: 0.8;
    }
    
    /* Report Body */
    .report-body {
        padding: 2rem;
    }
    
    /* Sections */
    .report-section {
        margin-bottom: 2.5rem;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid var(--primary);
        padding-bottom: 0.5rem;
    }
    
    .section-header i {
        color: var(--primary);
        font-size: 1.5rem;
        margin-right: 1rem;
    }
    
    .section-header h2 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--primary-dark);
    }
    
    /* Symptoms */
    .symptom-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
    }
    
    .symptom-chip {
        background: var(--secondary);
        padding: 0.6rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: var(--transition);
    }
    
    .symptom-chip:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
    }
    
    /* Diagnosis Card */
    .diagnosis-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        border-left: 5px solid var(--primary);
    }
    
    .diagnosis-card.severity-high {
        border-left-color: var(--danger);
    }
    
    .diagnosis-card.severity-medium {
        border-left-color: var(--warning);
    }
    
    .diagnosis-card.severity-low {
        border-left-color: var(--success);
    }
    
    .diagnosis-content h3 {
        margin-top: 0;
        color: var(--text);
        font-weight: 600;
    }
    
    .confidence-meter {
        margin-top: 1.5rem;
    }
    
    .meter-labels {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #666;
    }
    
    .meter-bar {
        height: 10px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .meter-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-light), var(--primary));
        border-radius: 5px;
        transition: width 1s ease;
    }
    
    .severity-indicator {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        display: flex;
        align-items: center;
    }
    
    .severity-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .severity-high .severity-dot {
        background: var(--danger);
    }
    
    .severity-medium .severity-dot {
        background: var(--warning);
    }
    
    .severity-low .severity-dot {
        background: var(--success);
    }
    
    /* Treatment Plan */
    .treatment-plan {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }
    
    .treatment-steps {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        white-space: pre-line;
    }
    
    .treatment-notes {
        background: #e8f5e9;
        padding: 1.5rem;
        border-radius: var(--border-radius);
    }
    
    .treatment-notes h4 {
        margin-top: 0;
        color: var(--primary-dark);
    }
    
    .treatment-notes ul {
        padding-left: 1.2rem;
    }
    
    .treatment-notes li {
        margin-bottom: 0.5rem;
    }
    
    /* Prevention */
    .prevention-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    
    .prevention-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        display: flex;
        align-items: flex-start;
        transition: var(--transition);
    }
    
    .prevention-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .prevention-icon {
        color: var(--primary);
        font-size: 1.2rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .prevention-card p {
        margin: 0;
    }
    
    /* Footer */
    .report-footer {
        background: #f8f9fa;
        padding: 1.5rem 2rem;
        border-top: 1px solid #e9ecef;
    }
    
    .footer-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .btn-print, .btn-pdf {
        padding: 0.8rem 1.8rem;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
    }
    
    .btn-print {
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
    }
    
    .btn-print:hover {
        background: var(--primary);
        color: white;
    }
    
    .btn-pdf {
        background: var(--primary);
        color: white;
        border: 2px solid var(--primary);
    }
    
    .btn-pdf:hover {
        background: var(--primary-dark);
    }
    
    .btn-print i, .btn-pdf i {
        margin-right: 0.5rem;
    }
    
    .footer-disclaimer {
        text-align: center;
        font-size: 0.85rem;
        color: #6c757d;
        max-width: 600px;
        margin: 0 auto;
    }
    
    /* Print Styles */
    @media print {
        body {
            background: white !important;
        }
        
        .report-card {
            box-shadow: none;
            border-radius: 0;
        }
        
        .report-footer {
            display: none;
        }
        
        .symptom-chip:hover, .prevention-card:hover {
            transform: none !important;
        }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .report-header {
            padding: 1.5rem;
        }
        
        .report-title {
            font-size: 1.5rem;
        }
        
        .report-body {
            padding: 1.5rem;
        }
        
        .treatment-plan {
            grid-template-columns: 1fr;
        }
        
        .footer-actions {
            flex-direction: column;
            align-items: center;
        }
        
        .btn-print, .btn-pdf {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}